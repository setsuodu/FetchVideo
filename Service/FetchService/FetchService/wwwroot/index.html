<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>连号图片下载器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            padding: 2rem;
            background: #f8f9fa;
        }

        .card {
            max-width: 600px;
            margin: auto;
        }

        .progress {
            height: 1.5rem;
        }

        #log {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">连号图片批量下载器</h4>
        </div>
        <div class="card-body">
            <form id="downloadForm">
                <div class="mb-3">
                    <label class="form-label">第一张图片 URL</label>
                    <input type="url" class="form-control" id="firstUrl" required
                           placeholder="https://picsum.photos/id/0/600/400" />
                </div>
                <div class="mb-3">
                    <label class="form-label">最后一张图片 URL</label>
                    <input type="url" class="form-control" id="lastUrl" required
                           placeholder="https://picsum.photos/id/10/600/400" />
                </div>
                <div class="mb-3">
                    <label class="form-label">并发数（1~20）</label>
                    <input type="number" class="form-control" id="concurrency" value="5" min="1" max="20" />
                </div>
                <button type="submit" class="btn btn-success w-100">开始下载</button>
            </form>

            <hr />

            <div id="result" class="d-none">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar"
                         style="width: 0%">0%</div>
                </div>
                <p id="status">准备中...</p>
                <pre id="log" class="bg-light p-3 border"></pre>
                <a id="logLink" class="btn btn-sm btn-outline-secondary d-none" download>下载 404 日志</a>
            </div>
        </div>
    </div>

    <script>
    const form = document.getElementById('downloadForm');
    const resultDiv = document.getElementById('result');
    const progressBar = document.getElementById('progressBar');
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const logLink = document.getElementById('logLink');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultDiv.classList.remove('d-none');
      progressBar.style.width = '0%';
      status.textContent = '正在解析 URL...';
      log.textContent = '';
      logLink.classList.add('d-none');

      const payload = {
        FirstUrl: document.getElementById('firstUrl').value.trim(),
        LastUrl: document.getElementById('lastUrl').value.trim(),
        Concurrency: parseInt(document.getElementById('concurrency').value) || 5
      };

      try {
        const response = await fetch('/api/download/download-batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.title || '请求失败');
        }

        // 模拟进度（实际可改为轮询或 WebSocket）
        const total = data.Total || 1;
        let downloaded = 0;
        const interval = setInterval(() => {
          downloaded += Math.floor(Math.random() * 3) + 1;
          if (downloaded >= data.Downloaded) {
            downloaded = data.Downloaded;
            clearInterval(interval);
          }
          const percent = Math.min((downloaded / total) * 100, 100);
          progressBar.style.width = percent + '%';
          progressBar.textContent = Math.round(percent) + '%';
        }, 300);

        // 最终结果
        setTimeout(() => {
          clearInterval(interval);
          progressBar.style.width = '100%';
          progressBar.textContent = '100%';
          status.innerHTML = `
            <strong>完成！</strong><br>
            总数: ${data.Total}，成功: ${data.Downloaded}，失败: ${data.Failed}
          `;
          if (data.LogPath) {
            logLink.href = data.LogPath.replace('/app/downloads', '/downloads');
            logLink.classList.remove('d-none');
          }
        }, Math.max(1500, total * 100)); // 粗略模拟

        log.textContent = `请求已提交，预计下载 ${total} 张图片...\n`;
      } catch (err) {
        status.innerHTML = `<span class="text-danger">错误: ${err.message}</span>`;
        log.textContent = '';
      }
    });
    </script>
</body>
</html>