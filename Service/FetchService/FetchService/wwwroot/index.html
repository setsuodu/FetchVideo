<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>连号图片下载器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            padding: 2rem;
            background: #f8f9fa;
        }

        .card {
            max-width: 600px;
            margin: auto;
        }

        .progress {
            height: 1.5rem;
        }

        #log {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">连号图片批量下载器</h4>
        </div>
        <div class="card-body">
            <form id="downloadForm">
                <div class="mb-3">
                    <label class="form-label">第一张图片 URL</label>
                    <input type="url" class="form-control" id="firstUrl" required
                           placeholder="https://picsum.photos/id/0/600/400" />
                </div>
                <div class="mb-3">
                    <label class="form-label">最后一张图片 URL</label>
                    <input type="url" class="form-control" id="lastUrl" required
                           placeholder="https://picsum.photos/id/10/600/400" />
                </div>
                <div class="mb-3">
                    <label class="form-label">并发数（1~20）</label>
                    <input type="number" class="form-control" id="concurrency" value="5" min="1" max="20" />
                </div>
                <button type="submit" class="btn btn-success w-100">开始下载</button>
            </form>

            <hr />

            <div id="result" class="d-none">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar"
                         style="width: 0%">0%</div>
                </div>
                <p id="status">准备中...</p>
                <pre id="log" class="bg-light p-3 border"></pre>
                <a id="logLink" class="btn btn-sm btn-outline-secondary d-none" download>下载 404 日志</a>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('downloadForm');
        const resultDiv = document.getElementById('result');
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        const logLink = document.getElementById('logLink');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. 初始化 UI
            resultDiv.classList.remove('d-none');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            status.textContent = '正在解析 URL...';
            log.textContent = '';
            logLink.classList.add('d-none');

            const payload = {
                FirstUrl: document.getElementById('firstUrl').value.trim(),
                LastUrl: document.getElementById('lastUrl').value.trim(),
                Concurrency: parseInt(document.getElementById('concurrency').value) || 5
            };

            try {
                // 2. 提交请求（异步，不等待）
                const responsePromise = fetch('/api/download/download-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 3. 假进度：从 0% 走到 90%（缓慢动画）
                let fakeProgress = 0;
                const fakeInterval = setInterval(() => {
                    fakeProgress += Math.random() * 8 + 2; // 每次跳 2~10%
                    if (fakeProgress >= 90) {
                        fakeProgress = 90;
                        clearInterval(fakeInterval);
                    }
                    progressBar.style.width = fakeProgress + '%';
                    progressBar.textContent = Math.round(fakeProgress) + '%';
                }, 300);

                // 4. 等待真实结果
                const response = await responsePromise;
                const data = await response.json();

                clearInterval(fakeInterval); // 停止假进度

                if (!response.ok) {
                    throw new Error(data.message || data.title || '请求失败');
                }

                // 5. 瞬间跳到 100% + 显示结果
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.classList.remove('progress-bar-animated');

                status.innerHTML = `
            <strong class="text-success">下载完成！</strong><br>
            文件夹: <code>${data.Folder || '—'}</code><br>
            总数: ${data.Total}，成功: ${data.Downloaded}，失败: ${data.Failed}
          `;

                log.textContent = `预计下载 ${data.Total} 张图片，已全部处理完毕。`;

                if (data.LogPath) {
                    logLink.href = data.LogPath;
                    logLink.textContent = `下载 404 日志 (${data.Folder}/download_404.txt)`;
                    logLink.classList.remove('d-none');
                }

            } catch (err) {
                progressBar.style.width = '100%';
                progressBar.textContent = '错误';
                progressBar.classList.add('bg-danger');
                status.innerHTML = `<span class="text-danger">错误: ${err.message}</span>`;
                log.textContent = '';
            }
        });
    </script>
</body>
</html>